ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x)) #grep colnames based on y list
ci <- c(ci, j) #return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
sf_inqueries[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(sf_inqueries))]
sf_attempts_0[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(sf_attempts_0))]
sf_attempts_1[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(sf_attempts_1))]
#properties with > 1 attempts to sell
sf_attempts_1 <- sfimport(here::here('data/sf_attempts-to-sell-1.csv'))
#properties with 0 attempts
sf_attempts_0 <- sfimport(here::here('data/sf_attempts-to-sell-0.csv'))
#properties with 0 inqs
sf_inqueries <- sfimport(here::here('data/sf_prop-inqs.csv'))
#grop and create inqury count column for inquery df
sf_inqueries <- sf_inqueries %>%
group_by(RelatedPropertyParcelID) %>%
mutate(total_inqueries= n()) %>%
ungroup() %>%
distinct(RelatedPropertyParcelID, .keep_all=T)
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID","Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x)) #grep colnames based on y list
ci <- c(ci, j) #return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
sf_inqueries[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(sf_inqueries))]
grep("address", colnames(sf_inqueries))
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x)) #grep colnames based on y list
ci <- c(ci, j) #return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(j>0) {
ci <- c(ci, j)
}#return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(j>0) {
ci <- c(ci, j)
} else {
return()
}#return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
grep("Address",
colnames(sf_inqueries))
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(length(j)<1) {
ci <- c(ci, j)
} else {
return()
}#return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(length(j)<1) {
ci <- c(ci, j)
} else {
}#return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(length(j)<1) {
ci <- c(ci, j)
} else {
NULL }#return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#bind rows from list of dfs
sf_df <- bind_rows(sf_list, .id = "column_label")
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(is.numeric(j)==T) {
ci <- c(ci, j)
} #return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
grep("Address",
colnames(sf_inqueries))
grep("Address",
colnames(sf_attempts_0))
length(grep("Address",
colnames(sf_inqueries)))
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(length(j)>1) {
ci <- c(ci, j)
}
ci#return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))
ci <- c(ci,j)
}
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(sf_inqueries))
ci <- c(ci, j)}
ci <- c()
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(sf_inqueries))
ci <- c(ci, j)}
ci
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(sf_attempts_0))
ci <- c(ci, j)}
ci
rm(c)
rm(ci)
ci <- c()
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(sf_attempts_0))
ci <- c(ci, j)}
ci
rm(ci)
ci<-c()
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(sf_attempts_0))
ci <- c(ci, j)}
ci
rm(ci)
ci<-c
ci<-c()
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(sf_attempts_1))
ci <- c(ci, j)}
ci
y
y[-2]
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
if(length(j)>1) {
ci <- c(ci, j)
} #return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y[-2]
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#create list of site dfs
sf_list <- list(sf_attempts_0, sf_attempts_1, sf_inqueries)
names(sf_list) <- c("sf_attempts_0","sf_attempts_1", "sf_inqueries")
#function for selecting cols and joining parcel geoms
get_cols <- function(x, geo_p) {
#select columns based on strings- done to standardize data
x <- x[,grepl("ParcelID|AccountN|Address|Program|District|Neighborhood|PropertyClass",
colnames(x))]
#create list of columns to search for and rename
y <- c("ParcelID", "AccountN", "Address", "Program","District", "Neighborhood", "PropertyClass")
ci <- c()
#get index of colname that matches
for(i in 1:length(y)) {
j <- grep(y[i],
colnames(x))#grep colnames based on y list
ci <- c(ci, j) #return vector of indices
}
x<-x[, ci] #reorder columns based on index
#rename cols for later binding
colnames(x) <- y[-2]
#rename parcel id cols
colnames(x)[1] <- "ParcelID_structure" #rename parcel id col for joining
x$index <- 1:nrow(x) #create index row for rejoining data
#join data to parcel for geoms
x<- merge(x, geo_p[,'parcel_number'], by.x="ParcelID_structure", by.y="parcel_number")
x <- st_as_sf(x) %>% st_transform(2898)#transform crs
}
#apply function to return list of dfs
sf_list <- lapply(sf_list, get_cols,geo_p) #return list of dfs with parcel geoms
#bind rows from list of dfs
sf_df <- bind_rows(sf_list, .id = "column_label")
### join main structures parcel geoms and transform
sf_main <- sf_main %>% left_join(geo_p, by =c("ParcelID"="parcel_number"))
sf_main <- sf_main %>% st_as_sf() %>% st_transform(2898) %>% st_centroid() #transform
#### Spatial Operations ####
nearest_feature <- st_nearest_feature(sf_df, sf_main) #get nearest feature for each site
#get distance of all sites to structures
#creates matrix for filtering within app
dist2 <- st_distance(sf_df, sf_main)
dist2 <- as.matrix(dist2)
#get distance to nearest feature for each site in relation to main structure
nearest_dist <- st_distance(sf_df, sf_main[nearest_feature,],by_element=T)
#bind distance to nearest feature to dataframe
sf_df <- cbind(sf_df, nearest_dist)
#get index of nearest feature for each site
sf_df <- cbind(sf_df, nearest_feature)
#generate index for structures to match
sf_main$index <- 1:nrow(sf_main)
#join dfs by index
sf_df <- sf_df %>%
left_join(st_drop_geometry(sf_main[,c("index","ParcelID")]),
by = c("nearest_feature"='index')) %>%
rename(ParcelID_site=ParcelID)
#set up quantiles for adding quant col
classes <- 5
quantiles <- sf_df %>%
pull(nearest_dist) %>%
quantile() %>%
as.vector()
# here create custom labels
labels <- purrr::imap_chr(quantiles, function(., idx){
return(paste0(round(quantiles[idx], 0),
"ft",
" â€“ ",
round(quantiles[idx + 1], 0),
"ft"))
})
labels <- labels[1:length(labels) - 1]
sf_df <- sf_df %>%  mutate(quantiles = cut(nearest_dist,
breaks = quantiles,
labels = labels,
include.lowest = T))
sf_df <- st_drop_geometry(sf_df)
sf_df <- sf_df %>% left_join(geo_p[,"parcel_number"], by = c("ParcelID_structure"="parcel_number"))
sf_df <- sf_df %>% st_as_sf()
sf_main <- st_drop_geometry(sf_main)
sf_main <- sf_main %>% left_join(geo_p[,"parcel_number"], by=c("ParcelID"="parcel_number"))
sf_main <- sf_main %>% st_as_sf()
saveRDS(dist2, here::here('appData/distance-matrix.RDS'))
saveRDS(sf_df,here::here('appData/sites.RDS'))
saveRDS(sf_main, here::here("appData/main.RDS"))
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
#read in potential site data
sites <- readRDS(here::here('appData/sites.RDS')) %>%
st_transform(4326) %>%
st_cast("POLYGON") %>%
filter(!ParcelID_structure %in% main$ParcelID)
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
